{{Player}}

{{Lyrics}}
{{SongName}}

<div id="lyrics"></div>

<script>
  const audio = document.getElementById("audio");
  const lyricsDiv = document.getElementById("lyrics");
  const lyricElement = document.getElementById("lyricData");
  const songNameElement = document.getElementById("songNameData");
  let lyrics = [];
  if (lyricElement) {
    try {
      lyrics = JSON.parse(lyricElement.textContent.trim());
    } catch (e) {
      console.error("Local JSON lỗi:", e);
    }
  }

  let songName = "";
  if (songNameElement) {
    songName = songNameElement.textContent.trim();
  }

  // Escape HTML helper
  function escapeHtml(t) {
    const div = document.createElement('div');
    div.textContent = t;
    return div.innerHTML;
  }

  // Render a single line with furigana + Vietnamese
  function renderLine(line) {
    let kanjiHTML = '';

    if (!line.furigana || line.furigana.length === 0) {
      kanjiHTML = escapeHtml(line.kanji);
    } else {
      let text = line.kanji;
      let offset = 0;
      const sorted = [...line.furigana].sort((a, b) =>
        text.indexOf(a.char, offset) - text.indexOf(b.char, offset)
      );

      for (const f of sorted) {
        const idx = text.indexOf(f.char, offset);
        if (idx === -1) continue;

        if (idx > offset) kanjiHTML += escapeHtml(text.substring(offset, idx));

        const readingNorm = f.reading.replace(/[ーっ]/g, '').trim();
        const charNorm = f.char.replace(/[ーっ]/g, '').trim();
        const needFuri = readingNorm !== charNorm && f.reading.trim() !== '';

        if (needFuri) {
          kanjiHTML += `<span class="furi-group">
                        <span class="furi">${escapeHtml(f.reading)}</span>
                        <span class="line"></span>
                        ${escapeHtml(f.char)}
                      </span>`;
        } else {
          kanjiHTML += escapeHtml(f.char);
        }

        offset = idx + f.char.length;
      }

      if (offset < text.length) kanjiHTML += escapeHtml(text.substring(offset));
    }

    return `<div class="kanji">${kanjiHTML}</div>
          <div class="vietnamese">${escapeHtml(line.translation)}</div>`;
  }

  // Try fetching lyrics from GitHub if song name is not null or empty

  /// contruct GitHub URL with song name
  if (songName) {
    const githubURL = `https://raw.githubusercontent.com/PRID021/JLPT_TRANS/refs/heads/main/${songName}/lyrics.json`;
    fetch(githubURL)
      .then(res => res.json())
      .then(data => {
        lyrics = data;
        console.log("Loaded lyrics from GitHub");
      })
      .catch(err => {
        console.warn("Cannot load lyrics from GitHub, using local version.", err);
      });
  }

  // Sync lyrics with audio
  audio.addEventListener("timeupdate", () => {
    const t = audio.currentTime;
    const cur = lyrics.find(l => t >= l.start && t < (l.end || Infinity));
    lyricsDiv.innerHTML = cur ? renderLine(cur) : "";
  });
</script>